<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå¯†é’¥ç®¡ç† - Business Gemini Pool</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* å¯¼èˆªæŒ‰é’® */
        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #333;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group textarea,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
            transition: border-color 0.3s ease;
            background: white;
        }

        .form-group textarea:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-container {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .checkbox-cell {
            width: 50px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #333;
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* é”™è¯¯å’ŒæˆåŠŸæ¶ˆæ¯ */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* å¾½ç« æ ·å¼ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .card {
                padding: 20px;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
                padding: 20px;
            }

            .table-container {
                padding: 15px;
            }

            th, td {
                padding: 8px;
                font-size: 0.9em;
            }
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        /* ç»Ÿè®¡ä¿¡æ¯ */
        .stats-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ”‘ APIå¯†é’¥ç®¡ç†ä¸­å¿ƒ</h1>
            <p>æ‰¹é‡ç®¡ç†ã€å¯¼å…¥å’Œç»Ÿè®¡åˆ†æAPIå¯†é’¥</p>
        </div>

        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="nav-buttons">
            <a href="index.html" class="nav-btn">
                <span>ğŸ </span>
                <span>ä¸»é¡µ</span>
            </a>
            <a href="conversation_manager.html" class="nav-btn">
                <span>ğŸ’¬</span>
                <span>ä¼šè¯ç®¡ç†</span>
            </a>
            <a href="image_gallery.html" class="nav-btn">
                <span>ğŸ–¼ï¸</span>
                <span>å›¾ç‰‡ç›¸å†Œ</span>
            </a>
            <a href="analytics.html" class="nav-btn">
                <span>ğŸ“Š</span>
                <span>ç»Ÿè®¡åˆ†æ</span>
            </a>
            <a href="api_key_manager.html" class="nav-btn active">
                <span>ğŸ”‘</span>
                <span>å¯†é’¥ç®¡ç†</span>
            </a>
        </div>

        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="messageArea"></div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <!-- æ‰¹é‡å¯¼å…¥ -->
            <div class="card">
                <h3>ğŸ“¥ æ‰¹é‡å¯¼å…¥APIå¯†é’¥</h3>
                <div class="form-group">
                    <label for="importData">JSONæ ¼å¼çš„è´¦å·æ•°æ®</label>
                    <textarea id="importData" placeholder='[
  {
    "team_id": "your_team_id_1",
    "email": "email1@example.com",
    "user_agent": "Mozilla/5.0..."
  },
  {
    "team_id": "your_team_id_2",
    "email": "email2@example.com"
  }
]'></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="importApiKeys()">
                        <span>ğŸ“¥</span>
                        <span>æ‰¹é‡å¯¼å…¥</span>
                    </button>
                    <button class="btn btn-secondary" onclick="loadExample()">
                        <span>ğŸ“</span>
                        <span>åŠ è½½ç¤ºä¾‹</span>
                    </button>
                </div>
            </div>

            <!-- å±é™©æ“ä½œ -->
            <div class="card">
                <h3>âš ï¸ å±é™©æ“ä½œ</h3>
                <div class="stats-info">
                    <div class="stat-item">
                        <div class="stat-value" id="totalKeys">-</div>
                        <div class="stat-label">æ€»APIå¯†é’¥æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeKeys">-</div>
                        <div class="stat-label">æ´»è·ƒå¯†é’¥æ•°</div>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="exportApiKeys()">
                        <span>ğŸ“¤</span>
                        <span>å¯¼å‡ºæ•°æ®</span>
                    </button>
                    <button class="btn btn-danger" onclick="showBatchDeleteModal()">
                        <span>ğŸ—‘ï¸</span>
                        <span>æ‰¹é‡åˆ é™¤</span>
                    </button>
                    <button class="btn btn-danger" onclick="showClearAllModal()">
                        <span>ğŸ’£</span>
                        <span>æ¸…ç©ºæ‰€æœ‰</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- APIå¯†é’¥åˆ—è¡¨ -->
        <div class="table-container">
            <h3>ğŸ“‹ APIå¯†é’¥åˆ—è¡¨</h3>
            <div class="btn-group" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="selectAll()">å…¨é€‰</button>
                <button class="btn btn-secondary" onclick="deselectAll()">å–æ¶ˆå…¨é€‰</button>
                <button class="btn btn-danger" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">
                    <span>ğŸ—‘ï¸</span>
                    <span>åˆ é™¤é€‰ä¸­</span>
                </button>
            </div>
            <div id="apiKeysTable">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨åŠ è½½APIå¯†é’¥æ•°æ®...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="batchDeleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤æ‰¹é‡åˆ é™¤</h3>
                <span class="close" onclick="closeBatchDeleteModal()">&times;</span>
            </div>
            <p>æ‚¨ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <span id="deleteCount">0</span> ä¸ªAPIå¯†é’¥å—ï¼Ÿ</p>
            <p><strong>æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼</strong></p>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="confirmBatchDelete()">ç¡®è®¤åˆ é™¤</button>
                <button class="btn btn-secondary" onclick="closeBatchDeleteModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¸…ç©ºæ‰€æœ‰ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="clearAllModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš ï¸ ç¡®è®¤æ¸…ç©ºæ‰€æœ‰æ•°æ®</h3>
                <span class="close" onclick="closeClearAllModal()">&times;</span>
            </div>
            <p><strong>è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰APIå¯†é’¥ç»Ÿè®¡æ•°æ®ï¼Œä¸”æ— æ³•æ¢å¤ï¼</strong></p>
            <p>è¯·åœ¨ä¸‹æ–¹è¾“å…¥ <code>CLEAR_ALL_API_KEYS_CONFIRMED</code> ä»¥ç¡®è®¤æ­¤æ“ä½œï¼š</p>
            <div class="form-group">
                <input type="text" id="confirmationText" placeholder="è¾“å…¥ç¡®è®¤æ–‡æœ¬">
            </div>
            <div class="btn-group">
                <button class="btn btn-danger" onclick="confirmClearAll()">ç¡®è®¤æ¸…ç©º</button>
                <button class="btn btn-secondary" onclick="closeClearAllModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/v1';
        let selectedKeys = new Set();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadApiKeys();
            loadStats();
        });

        // è·å–APIè¯·æ±‚å¤´
        function getApiHeaders() {
            const apiKey = localStorage.getItem('gemini_api_key') || '';
            const headers = {
                'Content-Type': 'application/json'
            };
            if (apiKey) {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
            return headers;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;

            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // åŠ è½½APIå¯†é’¥åˆ—è¡¨
        async function loadApiKeys() {
            try {
                const response = await fetch(`${API_BASE}/analytics/api-keys`, {
                    headers: getApiHeaders()
                });

                if (!response.ok) throw new Error('è·å–APIå¯†é’¥åˆ—è¡¨å¤±è´¥');

                const data = await response.json();
                renderApiKeysTable(data.api_keys);
                updateSelectionButtons();

            } catch (error) {
                console.error('åŠ è½½APIå¯†é’¥å¤±è´¥:', error);
                document.getElementById('apiKeysTable').innerHTML = `
                    <div class="message error">åŠ è½½APIå¯†é’¥åˆ—è¡¨å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/analytics/api-keys?limit=1000`, {
                    headers: getApiHeaders()
                });

                if (!response.ok) throw new Error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥');

                const data = await response.json();
                const totalKeys = data.api_keys.length;
                const activeKeys = data.api_keys.filter(key => key.is_active).length;

                document.getElementById('totalKeys').textContent = totalKeys;
                document.getElementById('activeKeys').textContent = activeKeys;

            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('totalKeys').textContent = '0';
                document.getElementById('activeKeys').textContent = '0';
            }
        }

        // æ¸²æŸ“APIå¯†é’¥è¡¨æ ¼
        function renderApiKeysTable(apiKeys) {
            const container = document.getElementById('apiKeysTable');

            if (!apiKeys || apiKeys.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;">ğŸ”‘</div>
                        <div>æš‚æ— APIå¯†é’¥æ•°æ®</div>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>APIå¯†é’¥</th>
                            <th>Team ID</th>
                            <th>é‚®ç®±</th>
                            <th>æ€»è¯·æ±‚</th>
                            <th>æˆåŠŸè¯·æ±‚</th>
                            <th>æˆåŠŸç‡</th>
                            <th>ç”Ÿæˆå›¾ç‰‡</th>
                            <th>æœ€åä½¿ç”¨</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            apiKeys.forEach(key => {
                const successRate = key.success_rate_percent || 0;
                const lastUsed = key.last_used_at ? new Date(key.last_used_at).toLocaleString('zh-CN') : 'ä»æœªä½¿ç”¨';
                const maskedKey = key.api_key_masked || 'æœªçŸ¥';
                const isActive = key.is_active;

                tableHTML += `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" value="${key.api_key_hash}" onchange="toggleKeySelection('${key.api_key_hash}')">
                        </td>
                        <td><code>${maskedKey}</code></td>
                        <td>${key.account_team_id || 'æœªçŸ¥'}</td>
                        <td>${key.account_email || '-'}</td>
                        <td>${key.total_requests}</td>
                        <td>${key.successful_requests}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="progress-bar" style="flex: 1; min-width: 60px;">
                                    <div class="progress-fill" style="width: ${successRate}%"></div>
                                </div>
                                <span>${successRate}%</span>
                            </div>
                        </td>
                        <td>${key.total_images_generated}</td>
                        <td>${lastUsed}</td>
                        <td>
                            ${isActive ? '<span class="badge badge-success">æ´»è·ƒ</span>' : '<span class="badge badge-warning">éæ´»è·ƒ</span>'}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-danger" onclick="deleteSingleKey('${key.api_key_hash}')">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('#apiKeysTable input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (checkbox.value) {
                    if (selectAllCheckbox.checked) {
                        selectedKeys.add(checkbox.value);
                    } else {
                        selectedKeys.delete(checkbox.value);
                    }
                }
            });

            updateSelectionButtons();
        }

        function selectAll() {
            document.getElementById('selectAllCheckbox').checked = true;
            toggleSelectAll();
        }

        function deselectAll() {
            document.getElementById('selectAllCheckbox').checked = false;
            toggleSelectAll();
        }

        // åˆ‡æ¢å•ä¸ªé€‰æ‹©
        function toggleKeySelection(keyHash) {
            if (selectedKeys.has(keyHash)) {
                selectedKeys.delete(keyHash);
            } else {
                selectedKeys.add(keyHash);
            }
            updateSelectionButtons();
        }

        // æ›´æ–°é€‰æ‹©æŒ‰é’®çŠ¶æ€
        function updateSelectionButtons() {
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            if (selectedKeys.size > 0) {
                deleteBtn.style.display = 'inline-flex';
            } else {
                deleteBtn.style.display = 'none';
            }
        }

        // æ‰¹é‡å¯¼å…¥APIå¯†é’¥
        async function importApiKeys() {
            const textarea = document.getElementById('importData');
            const data = textarea.value.trim();

            if (!data) {
                showMessage('è¯·è¾“å…¥è¦å¯¼å…¥çš„JSONæ•°æ®', 'error');
                return;
            }

            try {
                const accounts = JSON.parse(data);

                if (!Array.isArray(accounts)) {
                    showMessage('æ•°æ®å¿…é¡»æ˜¯JSONæ•°ç»„æ ¼å¼', 'error');
                    return;
                }

                showMessage('æ­£åœ¨å¯¼å…¥APIå¯†é’¥...', 'warning');

                const response = await fetch(`${API_BASE}/api-keys/batch-import`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ accounts: accounts })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'å¯¼å…¥å¤±è´¥');
                }

                showMessage(`å¯¼å…¥æˆåŠŸï¼å¯¼å…¥ ${result.imported_count} ä¸ªï¼Œè·³è¿‡ ${result.skipped_count} ä¸ªï¼Œé”™è¯¯ ${result.error_count} ä¸ª`, 'success');

                // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                if (result.details && result.details.length > 0) {
                    console.log('å¯¼å…¥è¯¦æƒ…:', result.details);
                }

                // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡æ–°åŠ è½½æ•°æ®
                textarea.value = '';
                loadApiKeys();
                loadStats();

            } catch (error) {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                showMessage(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½ç¤ºä¾‹æ•°æ®
        function loadExample() {
            const exampleData = [
                {
                    "team_id": "example_team_id_001",
                    "email": "user1@example.com",
                    "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
                },
                {
                    "team_id": "example_team_id_002",
                    "email": "user2@example.com",
                    "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
                },
                {
                    "team_id": "example_team_id_003",
                    "email": "user3@example.com"
                }
            ];

            document.getElementById('importData').value = JSON.stringify(exampleData, null, 2);
            showMessage('å·²åŠ è½½ç¤ºä¾‹æ•°æ®ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹', 'success');
        }

        // å¯¼å‡ºAPIå¯†é’¥
        async function exportApiKeys() {
            try {
                showMessage('æ­£åœ¨å¯¼å‡ºAPIå¯†é’¥æ•°æ®...', 'warning');

                const response = await fetch(`${API_BASE}/api-keys/export`, {
                    headers: getApiHeaders()
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'å¯¼å‡ºå¤±è´¥');
                }

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `api_keys_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                showMessage(`æˆåŠŸå¯¼å‡º ${data.total_count} ä¸ªAPIå¯†é’¥`, 'success');

            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showMessage(`å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤æ¨¡æ€æ¡†
        function showBatchDeleteModal() {
            if (selectedKeys.size === 0) {
                showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„APIå¯†é’¥', 'warning');
                return;
            }

            document.getElementById('deleteCount').textContent = selectedKeys.size;
            document.getElementById('batchDeleteModal').style.display = 'block';
        }

        // å…³é—­æ‰¹é‡åˆ é™¤æ¨¡æ€æ¡†
        function closeBatchDeleteModal() {
            document.getElementById('batchDeleteModal').style.display = 'none';
        }

        // ç¡®è®¤æ‰¹é‡åˆ é™¤
        async function confirmBatchDelete() {
            try {
                showMessage('æ­£åœ¨åˆ é™¤é€‰ä¸­çš„APIå¯†é’¥...', 'warning');

                const response = await fetch(`${API_BASE}/api-keys/batch-delete`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        api_key_hashes: Array.from(selectedKeys)
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                }

                showMessage(result.message, 'success');
                closeBatchDeleteModal();

                // æ¸…ç©ºé€‰æ‹©å¹¶é‡æ–°åŠ è½½æ•°æ®
                selectedKeys.clear();
                loadApiKeys();
                loadStats();

            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                showMessage(`æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ˜¾ç¤ºæ¸…ç©ºæ‰€æœ‰æ¨¡æ€æ¡†
        function showClearAllModal() {
            document.getElementById('clearAllModal').style.display = 'block';
        }

        // å…³é—­æ¸…ç©ºæ‰€æœ‰æ¨¡æ€æ¡†
        function closeClearAllModal() {
            document.getElementById('clearAllModal').style.display = 'none';
            document.getElementById('confirmationText').value = '';
        }

        // ç¡®è®¤æ¸…ç©ºæ‰€æœ‰
        async function confirmClearAll() {
            const confirmationText = document.getElementById('confirmationText').value.trim();

            if (confirmationText !== 'CLEAR_ALL_API_KEYS_CONFIRMED') {
                showMessage('ç¡®è®¤æ–‡æœ¬ä¸æ­£ç¡®ï¼Œæ“ä½œå·²å–æ¶ˆ', 'error');
                return;
            }

            try {
                showMessage('æ­£åœ¨æ¸…ç©ºæ‰€æœ‰APIå¯†é’¥æ•°æ®...', 'warning');

                const response = await fetch(`${API_BASE}/api-keys/clear-all`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        confirmation: confirmationText
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'æ¸…ç©ºå¤±è´¥');
                }

                showMessage(result.message, 'success');
                closeClearAllModal();

                // æ¸…ç©ºé€‰æ‹©å¹¶é‡æ–°åŠ è½½æ•°æ®
                selectedKeys.clear();
                loadApiKeys();
                loadStats();

            } catch (error) {
                console.error('æ¸…ç©ºå¤±è´¥:', error);
                showMessage(`æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤å•ä¸ªAPIå¯†é’¥
        async function deleteSingleKey(keyHash) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªAPIå¯†é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api-keys/batch-delete`, {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        api_key_hashes: [keyHash]
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                }

                showMessage(result.message, 'success');

                // é‡æ–°åŠ è½½æ•°æ®
                loadApiKeys();
                loadStats();

            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                showMessage(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤é€‰ä¸­çš„APIå¯†é’¥
        function deleteSelected() {
            showBatchDeleteModal();
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const batchModal = document.getElementById('batchDeleteModal');
            const clearModal = document.getElementById('clearAllModal');

            if (event.target === batchModal) {
                closeBatchDeleteModal();
            }
            if (event.target === clearModal) {
                closeClearAllModal();
            }
        }
    </script>
</body>
</html>